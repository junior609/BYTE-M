const {
Â  default: makeWASocket,
Â  useMultiFileAuthState,
Â  DisconnectReason,
Â  jidDecode
} = require('@whiskeysockets/baileys');

const { Boom } = require('@hapi/boom');
const qrcode = require('qrcode-terminal');

async function startBot() {
Â  const { state, saveCreds } = await useMultiFileAuthState('./auth');

Â  const sock = makeWASocket({ auth: state });

Â  sock.ev.on('connection.update', (update) => {
Â Â Â  const { connection, lastDisconnect, qr } = update;
Â Â Â  if (qr) qrcode.generate(qr, { small: true });
Â Â Â  if (connection === 'open') console.log('âœ… Bot connected!');
Â Â Â  if (connection === 'close') {
Â Â Â Â Â  const shouldReconnect = new Boom(lastDisconnect?.error)?.output?.statusCode !== DisconnectReason.loggedOut;
Â Â Â Â Â  if (shouldReconnect) startBot();
Â Â Â  }
Â  });

Â  sock.ev.on('creds.update', saveCreds);

Â  // ðŸ§  Group Command Handler
Â  sock.ev.on('messages.upsert', async ({ messages }) => {
Â Â Â  const msg = messages[0];
Â Â Â  if (!msg.message) return;

Â Â Â  const from = msg.key.remoteJid;
Â Â Â  const isGroup = from.endsWith('@g.us');
Â Â Â  const sender = msg.key.participant || msg.key.remoteJid;
Â Â Â  const text = msg.message.conversation || msg.message.extendedTextMessage?.text;

Â Â Â  if (!text) return;

Â Â Â  const command = text.toLowerCase().trim();

Â Â Â  if (command === '!help') {
Â Â Â Â Â  await sock.sendMessage(from, {
Â Â Â Â Â Â Â  text: `ðŸ›  *Group Commands:*
- !kick @user
- !groupinfo
- !tagall
- !help`
Â Â Â Â Â  });
Â Â Â  }

Â Â Â  // ðŸ”’ Group-only commands
Â Â Â  if (isGroup) {
Â Â Â Â Â  const metadata = await sock.groupMetadata(from);
Â Â Â Â Â  const isAdmin = metadata.participants.find(p => p.id === sender && p.admin);

Â Â Â Â Â  if (!isAdmin) {
Â Â Â Â Â Â Â  return await sock.sendMessage(from, { text: 'âŒ Only group admins can use this command.' });
Â Â Â Â Â  }

Â Â Â Â Â  // âœ… Kick Command
Â Â Â Â Â  if (command.startsWith('!kick')) {
Â Â Â Â Â Â Â  const mentioned = msg.message.extendedTextMessage?.contextInfo?.mentionedJid;
Â Â Â Â Â Â Â  if (!mentioned) return await sock.sendMessage(from, { text: 'Mention someone to kick, e.g., !kick @user' });

Â Â Â Â Â Â Â  await sock.groupParticipantsUpdate(from, mentioned, 'remove');
Â Â Â Â Â Â Â  return await sock.sendMessage(from, { text: `ðŸ‘¢ Kicked user.` });
Â Â Â Â Â  }

Â Â Â Â Â  // ðŸ§¾ Group Info
Â Â Â Â Â  if (command === '!groupinfo') {
Â Â Â Â Â Â Â  const name = metadata.subject;
Â Â Â Â Â Â Â  const memberCount = metadata.participants.length;
Â Â Â Â Â Â Â  await sock.sendMessage(from, {
Â Â Â Â Â Â Â Â Â  text: `ðŸ‘¥ *${name}*\nMembers: ${memberCount}`
Â Â Â Â Â Â Â  });
Â Â Â Â Â  }

Â Â Â Â Â  // ðŸ—£ Tag All
Â Â Â Â Â  if (command === '!tagall') {
Â Â Â Â Â Â Â  const mentions = metadata.participants.map(p => p.id);
Â Â Â Â Â Â Â  const tagMsg = mentions.map(u => `@${u.split('@')[0]}`).join(' ');
Â Â Â Â Â Â Â  await sock.sendMessage(from, {
Â Â Â Â Â Â Â Â Â  text: `ðŸ‘‹ ${tagMsg}`,
Â Â Â Â Â Â Â Â Â  mentions
Â Â Â Â Â Â Â  });
Â Â Â Â Â  }
Â Â Â  }
Â  });
}

startBot();
